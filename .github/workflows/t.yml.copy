#on:
#  push:
#    branches:
#      - staging
#      - production
#      - 'wudstrand/vodacast-functions#**'
##    paths:
##      - 'api/**'
##      - '!api/data/openapi/**'
#
#env:
#  MIN_CONNECTIONS: 10
#  MAX_CONNECTIONS: 15
#
#jobs:
#  discovery_api_staging:
#    name: Discovery API Staging Deployement
#    runs-on: ubuntu-latest
#    env:
#      GCP_PROJECT: vodacast-staging
#      DB: vodacast
#      DB_USER: postgres
#      CONNECTION_STR: 10.30.192.3
#
#    steps:
#      - name: Setup GCloud SDK Staging Environment
#        id: gcp
#        uses: 'Auddia/cicd/actions/setup_gcloud@wudstrand/cicd#1'
#        with:
#          gcp_credentials: '${{ secrets.VODACAST_STAGING_GCP_CREDENTIALS }}'
#          gcp_secrets: |
#            DB_PWD: projects/vodacast-staging/secrets/vodacast-postgres-password
#
#      - name: Build and Publish Docker Image.
#        uses: 'Auddia/cicd/actions/build_and_publish_image@wudstrand/cicd#1'
#        with:
#          tag: 'gcr.io/${{ env.GCP_PROJECT }}/discovery-api:${{ github.sha }}'
#          dockerfile: ./api/Dockerfile
#          build_args: |
#            --build-arg CONNECTION_STR \
#            --build-arg DB_USER \
#            --build-arg DB_PWD=${{ fromJson(steps.gcp.outputs.secrets).DB_PWD }} \
#            --build-arg MIN_CONNECTIONS \
#            --build-arg MAX_CONNECTIONS \
#
##      - name: Test docker image.
##        shell: bash
##        run: docker run gcr.io/${{ env.GCP_PROJECT }}/discovery-api:${{ github.sha }} env
#
##      - name: Deploy to Cloud Run
##        shell: bash
##        run: |
##          gcloud beta run deploy discovery-api \
##          --image gcr.io/${{ env.GCP_PROJECT }}/discovery-api:${{ github.sha }} \
##          --set-cloudsql-instances ${{ env.GCP_PROJECT }}:us-central1:${{ env.DB }} \
##          --region us-central1 \
##          --no-allow-unauthenticated \
##          --platform managed \
##          --vpc-connector ${{ env.GCP_PROJECT }}-default \
##          --cpu 2 \
##          --min-instances 2
