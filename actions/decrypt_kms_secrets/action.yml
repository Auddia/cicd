name: Decrypt KMS Secret
description: Using the gcloud command this action decrypts all the kms secrets requested
inputs:
  key_ring:
    description: The KMS keyring that that the secrets are being taken from
    required: true
  keys:
    description: 'The keys being requested in the format (key: cipher_text_location)'
    required: true
  output_dir:
    description: 'The location to store the decrypted keys'
    required: false
    default: '.'


runs:
  using: 'composite'
  steps:
    - name: Process KMS Input
      shell: bash
      run: |
        keys="${{ inputs.keys }}"
        echo "$keys" > input.txt
        arg_list=$(awk -F: '{print "--ciphertext-file "$2 " --plaintext-file ./keys/"$1".key" " --key "$1}' input.txt)
        echo "$arg_list" > /tmp/kms_decrypt_input

    - name: Decrypt Keys
      shell: bash
      run: |
        cat /tmp/kms_decrypt_input | xargs -I % gcloud kms decrypt % --location=us-central1 --keyring=${{ inputs.key_ring }}


        config="TEST_ONE: ONE
        TEST_TWO: TWO
        "
        echo "$config" > input.txt
        arg_list=$(awk -F: '{print "--build-arg "$1"="$2}' input.txt)
        cleaned_args=${arg_list//= /=}
        value=$(echo "$cleaned_args" | tr '\n' ' ')

        secret_args=''
        if [ -n "$secret_args" ];
        then
          echo "$secret_args" | tr -d "[\":]" > input.txt
          additional_args=$(awk '{print "--build-arg "$1"="$2}' input.txt)
          echo "additional_build_args=${value} ${additional_args}" >> "$GITHUB_ENV"
        else
          echo "additional_build_args=${value}" >> "$GITHUB_ENV"
        fi